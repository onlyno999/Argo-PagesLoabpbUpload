å½“ç„¶å¯ä»¥ï¼Œä»¥ä¸‹æ˜¯ä½ å®Œæ•´çš„ Auto Update _worker.js GitHub Actions å·¥ä½œæµï¼ŒåŠ å…¥äº†å…³é”®çš„ permissions è®¾ç½®ï¼Œä»¥ç¡®ä¿ GitHub Actions æœ‰æƒé™å°†æ›´æ–°æ¨é€å›ä½ çš„ä»“åº“ã€‚

âœ… æ”¹åŠ¨ç‚¹ï¼š

æ·»åŠ äº† permissions: contents: write

å…¶ä½™é€»è¾‘ä¸å˜


ğŸ‘‡ ä»¥ä¸‹æ˜¯æ›´æ–°åçš„ workflow æ–‡ä»¶ï¼ˆ.github/workflows/update-worker.ymlï¼‰ï¼š

name: Auto Update _worker.js

permissions: contents: write  # å…è®¸ github-actions[bot] æœ‰æƒé™æ‰§è¡Œ git push æ“ä½œ

on: schedule: - cron: '0 0 * * *'    # æ¯å¤©00:00 UTCè¿è¡Œ workflow_dispatch:       # å…è®¸æ‰‹åŠ¨è§¦å‘ inputs: release_type: description: 'é€‰æ‹©æ›´æ–°ç‰ˆæœ¬ç±»å‹' required: true default: 'release' type: choice options: - 'release' - 'prerelease'

jobs: update: runs-on: ubuntu-latest

steps:
  - name: Checkout ä»“åº“
    uses: actions/checkout@v4

  - name: æ£€æŸ¥å¹¶åˆå§‹åŒ– update_type.txt
    id: init_update_type_file
    run: |
      if [ ! -f "update_type.txt" ]; then
        echo "1" > update_type.txt
        echo "UPDATE_TYPE_FILE_CREATED=true" >> $GITHUB_ENV
        echo "update_type.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå·²è‡ªåŠ¨åˆ›å»ºå¹¶è®¾ç½®ä¸º '1' (æ­£å¼ç‰ˆ)ã€‚"
      else
        echo "update_type.txt æ–‡ä»¶å·²å­˜åœ¨ã€‚"
      fi

  - name: è·å–æœ€æ–° release ä¿¡æ¯
    id: get_release
    run: |
      RELEASE_TYPE_INPUT="${{ github.event.inputs.release_type }}"
      ACTUAL_RELEASE_TYPE=""

      if [ "${{ github.event_name }}" == "schedule" ]; then
        if [ -f "update_type.txt" ]; then
          FILE_CONTENT=$(cat update_type.txt | tr -d '\n' | tr -d '\r')
          if [ "$FILE_CONTENT" == "0" ]; then
            ACTUAL_RELEASE_TYPE="prerelease"
          else
            ACTUAL_RELEASE_TYPE="release"
          fi
        else
          ACTUAL_RELEASE_TYPE="release"
        fi
      else
        ACTUAL_RELEASE_TYPE="$RELEASE_TYPE_INPUT"
      fi

      echo "å½“å‰é€‰æ‹©çš„æ›´æ–°ç±»å‹: $ACTUAL_RELEASE_TYPE"

      if [ "$ACTUAL_RELEASE_TYPE" == "prerelease" ]; then
        latest_tag=$(curl -s https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases \
          | jq -r 'map(select(.prerelease == true and .draft == false)) | sort_by(.published_at) | .[-1].tag_name')
        if [ -z "$latest_tag" ]; then
          echo "æœªæ‰¾åˆ°ä»»ä½•é¢„å‘å¸ƒç‰ˆæœ¬ã€‚"
          exit 1
        fi
        echo "æœ€æ–°é¢„å‘å¸ƒç‰ˆæœ¬: $latest_tag"
      else
        latest_tag=$(curl -s https://api.github.com/repos/bia-pain-bache/BPB-Worker-Panel/releases/latest | jq -r '.tag_name')
        if [ -z "$latest_tag" ]; then
          echo "æœªæ‰¾åˆ°ä»»ä½•æ­£å¼å‘å¸ƒç‰ˆæœ¬ã€‚"
          exit 1
        fi
        echo "æœ€æ–°æ­£å¼å‘å¸ƒç‰ˆæœ¬: $latest_tag"
      fi
      echo "latest_tag=$latest_tag" >> $GITHUB_ENV
      echo "release_type=$ACTUAL_RELEASE_TYPE" >> $GITHUB_ENV

  - name: æ£€æŸ¥æœ¬åœ° version.txt
    id: check_version
    run: |
      if [ -f "version.txt" ]; then
        current_version=$(cat version.txt | tr -d '\n' | tr -d '\r')
        echo "å½“å‰æœ¬åœ°ç‰ˆæœ¬: $current_version"
      else
        echo "æœªæ‰¾åˆ° version.txtï¼Œè§†ä¸ºé¦–æ¬¡æ›´æ–°ã€‚"
        current_version=""
      fi
      echo "current_version=$current_version" >> $GITHUB_ENV

  - name: åˆ¤æ–­æ˜¯å¦éœ€è¦æ›´æ–°
    id: need_update
    run: |
      if [ "$current_version" = "$latest_tag" ]; then
        echo "No update needed."
        echo "need_update=false" >> $GITHUB_ENV
      else
        echo "Update needed."
        echo "need_update=true" >> $GITHUB_ENV
      fi

  - name: ä¸‹è½½å¹¶æ›¿æ¢ _worker.js
    if: env.need_update == 'true'
    run: |
      download_url="https://github.com/bia-pain-bache/BPB-Worker-Panel/releases/download/${{ env.latest_tag }}/worker.js"
      echo "ä¸‹è½½æ–‡ä»¶: $download_url"
      curl --retry 3 --retry-delay 5 -L -o _worker.js "$download_url"
      if [ ! -s "_worker.js" ]; then
        echo "_worker.js ä¸‹è½½å¤±è´¥æˆ–ä¸ºç©ºã€‚"
        exit 1
      fi
      echo "${{ env.latest_tag }}" > version.txt

  - name: æäº¤æ›´æ–°åˆ° GitHub
    if: env.need_update == 'true'
    run: |
      git config user.name "github-actions[bot]"
      git config user.email "github-actions[bot]@users.noreply.github.com"
      git add _worker.js version.txt
      git commit -m "Update _worker.js to version ${{ env.latest_tag }}"
      git push

  - name: æäº¤ update_type.txt (å¦‚æœè‡ªåŠ¨åˆ›å»º)
    if: env.UPDATE_TYPE_FILE_CREATED == 'true'
    run: |
      git config user.name "github-actions[bot]"
      git config user.email "github-actions[bot]@users.noreply.github.com"
      git add update_type.txt
      git commit -m "feat: Auto-created update_type.txt with default 'release' type"
      git push

  - name: å‘é€æ›´æ–°æˆåŠŸé€šçŸ¥ (å¤ç”¨æˆ–åˆ›å»º GitHub Issue)
    if: success() && env.need_update == 'true'
    uses: actions/github-script@v6
    with:
      github-token: ${{ secrets.GITHUB_TOKEN }}
      script: |
        const { owner, repo } = context.repo;
        const latestTag = process.env.latest_tag;
        const releaseType = process.env.release_type;
        const typeText = releaseType === 'prerelease' ? 'é¢„å‘å¸ƒç‰ˆæœ¬' : 'æ­£å¼ç‰ˆæœ¬';
        const notificationTitle = `_worker.js è‡ªåŠ¨æ›´æ–°é€šçŸ¥`;
        const notificationBody = `_worker.js å·²æˆåŠŸæ›´æ–°åˆ°${typeText} ${latestTag}ã€‚`;
        const timestamp = new Date().toLocaleString('zh-CN');

        const { data: issues } = await github.rest.issues.listForRepo({
          owner,
          repo,
          state: 'open',
          labels: 'auto-update-status-issue',
          per_page: 1
        });

        let targetIssue = null;
        if (issues.length > 0) {
          targetIssue = issues[0];
        }

        if (targetIssue) {
          await github.rest.issues.createComment({
            owner,
            repo,
            issue_number: targetIssue.number,
            body: `${notificationBody}\n\næ›´æ–°æ—¶é—´: ${timestamp}`
          });
          console.log(`å·²åœ¨ç°æœ‰ Issue #${targetIssue.number} ä¸Šæ·»åŠ è¯„è®ºã€‚`);
        } else {
          const { data: newIssue } = await github.rest.issues.create({
            owner,
            repo,
            title: notificationTitle,
            body: `${notificationBody}\n\næ›´æ–°æ—¶é—´: ${timestamp}`,
            labels: ['auto-update', 'success', 'auto-update-status-issue']
          });
          console.log(`å·²åˆ›å»ºæ–°çš„ Issue #${newIssue.number}ã€‚`);
        }

å¦‚æœä½ å·²ç»ä½¿ç”¨çš„æ˜¯ main åˆ†æ”¯ï¼Œå¹¶ä¸”å®ƒæ˜¯å—ä¿æŠ¤åˆ†æ”¯ï¼Œç¡®ä¿å…è®¸ github-actions[bot] è¿›è¡Œ pushã€‚å¦åˆ™ï¼Œå¯ä»¥è€ƒè™‘åˆ‡æ¢åˆ° dev åˆ†æ”¯ã€‚

å¦‚æœè¿˜æœ‰æŠ¥é”™ï¼Œæ¬¢è¿è´´æ—¥å¿—æˆ‘ç»§ç»­å¸®ä½ å¤„ç†ã€‚

